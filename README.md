# Conducting CoreDNS performance tests on a Kubernetes cluster

These manifests and scripts are part of the experiment used on the guide on how to conduct CoreDNS performance tests on a Kubernetes cluster.

## CoreDNS Helm Chart

These are the values used for deploying CoreDNS on a specific namespace. The helm chart used was: `https://github.com/coredns/helm`. Run the install command on the destination namespace, in this case, `coredns-test` through the command:

```
helm --namespace=coredns-test install coredns coredns/coredns --create-namespace --f dns-performance-tests/coredns-values.yaml
```

CoreDNS will use the `nodeSelector: coredns-test=coredns` value.

Remember to use the same resource limits and requests on both coredns and dnsperf deployments.

## Kubernetes client script

In the `kubernetes-client-script` folder run:
* npm install
* node index.js

It may take a few seconds to finish.

It will take the default cluster from the local KubeConfig and it will create the `coredns-services` namespace. It will generate a certain number of random Service resources according to `numberOfServices` variable and another set of random service names that don't exist in the cluster. When the script finishes, the file `generated-file.txt` will have domains from the `external-domains.txt` file and the generated ones from the script. The result from the `generated-file.txt` should be used as the contents for the `dns-records-config` ConfigMap on the `dnsperf.yaml` file.

## DNSPerf

`dnsperf.yaml` manifest should be populated with the domains generated by the `kubernetes-client-script` script. 

The file contains template for ConfigMap and Deployment manifest. Adapt the ConfigMap manifest with the domains that should be used for the performance test.

Replace the `DNS_SERVER_ADDR` env var with the relevant dns server ip address. It can be obtained through:
`kubectl get -n kube-system svc kube-dns -o go-template='{{.spec.clusterIP}}{{"\n"}}'`

DNSPerf will use the `nodeSelector: coredns-test=dnsperf` value.

Tweak the `MAX_TEST_SECONDS` `MAX_QPS` test parameters as you wish.

Once you're ready to run the test and CoreDNS is running, execute the following command:
```
kubectl apply -f dns-performance-tests/dnsperf.yaml
```

Remember to use the same resource limits and requests on both coredns and dnsperf deployments.
